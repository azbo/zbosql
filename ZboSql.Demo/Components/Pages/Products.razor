@page "/products"
@rendermode InteractiveServer
@using ZboSql.Demo.Services
@using ZboSql.Demo.Models
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@inject ProductService ProductService
@inject NavigationManager NavigationManager

<PageTitle>产品管理</PageTitle>

<div class="container-fluid">
    <h1>产品管理</h1>

    <!-- 搜索和筛选 -->
    <div class="row mb-3">
        <div class="col-md-4">
            <input @bind="searchKeyword" @bind:after="HandleSearch" class="form-control" placeholder="搜索产品名称..." />
        </div>
        <div class="col-md-3">
            <select @bind="categoryFilter" @bind:after="HandleSearch" class="form-select">
                <option value="">所有分类</option>
                @if (categories != null)
                {
                    @foreach (var cat in categories)
                    {
                        <option value="@cat">@cat</option>
                    }
                }
            </select>
        </div>
        <div class="col-md-3">
            <select @bind="orderBy" @bind:after="HandleSearch" class="form-select">
                <option value="">默认排序</option>
                <option value="name">按名称</option>
                <option value="price">按价格</option>
                <option value="stock">按库存</option>
                <option value="created">按创建时间</option>
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary w-100" @onclick="OpenCreateDialog">新增产品</button>
        </div>
    </div>

    <!-- 产品表格 -->
    @if (loading)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
        </div>
    }
    else if (products?.Count > 0)
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>产品名称</th>
                        <th>价格</th>
                        <th>库存</th>
                        <th>分类</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var product in products)
                    {
                        <tr>
                            <td>@product.Id</td>
                            <td>@product.ProductName</td>
                            <td>￥@product.Price.ToString("F2")</td>
                            <td>@product.StockQuantity</td>
                            <td>@product.Category</td>
                            <td>@product.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                            <td>
                                <button class="btn btn-sm btn-info me-2" @onclick="@(() => OpenEditDialog(product))">编辑</button>
                                <button class="btn btn-sm btn-danger" @onclick="@(() => HandleDelete(product))">删除</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- 分页 -->
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                共 @totalCount 条记录，第 @currentPage / @totalPages 页
            </div>
            <div>
                <button class="btn btn-sm btn-secondary me-2" disabled="@(currentPage == 1)" @onclick="() => ChangePage(currentPage - 1)">上一页</button>
                <button class="btn btn-sm btn-secondary" disabled="@(currentPage == totalPages)" @onclick="() => ChangePage(currentPage + 1)">下一页</button>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info">
            暂无数据，点击"新增产品"按钮添加产品。
        </div>
    }
</div>

<!-- 编辑/新增对话框 -->
@if (showDialog)
{
    <div class="modal fade show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(editingProduct?.Id == 0 ? "新增产品" : "编辑产品")</h5>
                    <button type="button" class="btn-close" @onclick="CloseDialog"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="@editingProduct" OnValidSubmit="HandleSave">
                        <DataAnnotationsValidator />

                        <div class="mb-3">
                            <label class="form-label">产品名称</label>
                            <InputText @bind-Value="editingProduct.ProductName" class="form-control" />
                            <ValidationMessage For="() => editingProduct.ProductName" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">价格</label>
                            <InputNumber @bind-Value="editingProduct.Price" class="form-control" />
                            <ValidationMessage For="() => editingProduct.Price" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">库存数量</label>
                            <InputNumber @bind-Value="editingProduct.StockQuantity" class="form-control" />
                            <ValidationMessage For="() => editingProduct.StockQuantity" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">分类</label>
                            <InputText @bind-Value="editingProduct.Category" class="form-control" placeholder="例如：电子产品、食品、服装" />
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseDialog">取消</button>
                            <button type="submit" class="btn btn-primary">保存</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

<style>
    .modal {
        background-color: rgba(0,0,0,0.5);
    }
</style>

@code {
    private List<Models.Product>? products;
    private List<string>? categories;
    private bool loading = true;
    private string searchKeyword = "";
    private string? categoryFilter;
    private string orderBy = "";
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalCount = 0;
    private int totalPages = 0;

    private bool showDialog = false;
    private Models.Product editingProduct = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        categories = await ProductService.GetCategoriesAsync();
    }

    private async Task LoadData()
    {
        loading = true;
        try
        {
            var result = await ProductService.GetProductsAsync(
                searchKeyword,
                categoryFilter,
                orderBy,
                false,
                currentPage,
                pageSize);

            products = result.Products;
            totalCount = result.TotalCount;
            totalPages = (int)Math.Ceiling((double)totalCount / pageSize);
        }
        finally
        {
            loading = false;
        }
    }

    private async Task HandleSearch()
    {
        currentPage = 1;
        await LoadData();
    }

    private async Task ChangePage(int page)
    {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        await LoadData();
    }

    private void OpenCreateDialog()
    {
        editingProduct = new Models.Product();
        showDialog = true;
    }

    private void OpenEditDialog(Models.Product product)
    {
        editingProduct = new Models.Product
        {
            Id = product.Id,
            ProductName = product.ProductName,
            Price = product.Price,
            StockQuantity = product.StockQuantity,
            Category = product.Category,
            CreatedAt = product.CreatedAt
        };
        showDialog = true;
    }

    private void CloseDialog()
    {
        showDialog = false;
        editingProduct = new Models.Product();
    }

    private async Task HandleSave()
    {
        if (editingProduct.Id == 0)
        {
            await ProductService.CreateAsync(editingProduct);
        }
        else
        {
            await ProductService.UpdateAsync(editingProduct);
        }

        CloseDialog();
        await LoadData();
    }

    private async Task HandleDelete(Models.Product product)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", $"确定要删除产品 '{product.ProductName}' 吗？"))
        {
            await ProductService.DeleteAsync(product.Id);
            await LoadData();
        }
    }
}
